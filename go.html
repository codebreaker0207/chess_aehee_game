<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>좀비 슈터 + 강화 (HTML5)</title>
  <style>
    :root{--bg:#0b0b0b;--panel:#1e1e1e;--white:#fff;--green:#00c050;--darkgreen:#2e7d32;--red:#dc2b2b;--gold:#ffd54f;--warning:#ff8c42}
    html,body{height:100%;margin:0;font-family: 'Malgun Gothic', Arial, sans-serif;background:var(--bg);color:var(--white)}
    .wrap{display:flex;align-items:flex-start;justify-content:center;padding:12px}
    canvas{background:#000;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
    .ui{width:320px;margin-left:16px}
    .panel{background:var(--panel);padding:12px;border-radius:8px;margin-bottom:12px}
    h2{margin:0 0 8px 0;font-size:18px}
    .big{font-size:22px;color:var(--gold);font-weight:700}
    button{background:#0e6efc;border:none;color:var(--white);padding:10px 12px;border-radius:8px;cursor:pointer}
    .btn-disabled{opacity:.45;pointer-events:none}
    .row{display:flex;gap:8px;align-items:center}
    .center{text-align:center}
    .msg{color:var(--warning);min-height:24px}
    .stat{font-size:14px}
    .buttons{display:flex;gap:8px;margin-top:8px}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="900" height="600"></canvas>
    <div class="ui">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="big" id="gold">골드: 0</div>
            <div class="stat" id="wave">웨이브: 0</div>
          </div>
          <div>
            <button id="switch">강화 게임으로 이동</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <div class="msg" id="message"></div>
      </div>

      <div id="zombieUi" class="panel">
        <h2>플레이어</h2>
        <div class="stat">체력: <span id="hp">0</span> / <span id="maxHp">0</span></div>
        <div class="stat">탄창: <span id="clip">0</span> / <span id="maxClip">0</span></div>
        <div style="height:8px"></div>
        <div class="small">이동: W A S D, 발사: 마우스 왼쪽, R: 재장전 / 재시작</div>
      </div>

      <div id="upgradeUi" class="panel" style="display:none">
        <h2>아이템 강화</h2>
        <div class="stat">현재 레벨: +<span id="level">0</span></div>
        <div class="stat">강화 비용: <span id="cost">0</span> 골드</div>
        <div class="stat">성공 확률: <span id="succ">0</span>%</div>
        <div class="stat">파괴 확률: <span id="dest">0</span>%</div>
        <div class="stat">판매가: <span id="sell">0</span> 골드</div>
        <div class="buttons">
          <button id="upgradeBtn">강화 시도</button>
          <button id="sellBtn">아이템 판매</button>
        </div>
        <div style="height:8px"></div>
        <div class="msg" id="upgradeMsg"></div>
      </div>

      <div class="panel">
        <h2>설정 (간단)</h2>
        <div class="row"><label>난이도:</label>
          <select id="difficulty">
            <option value="1">쉬움</option>
            <option value="1.5" selected>보통</option>
            <option value="2">어려움</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <script>
  // --- 기본 설정 ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // UI 엘리먼트
  const goldEl = document.getElementById('gold');
  const waveEl = document.getElementById('wave');
  const hpEl = document.getElementById('hp');
  const maxHpEl = document.getElementById('maxHp');
  const clipEl = document.getElementById('clip');
  const maxClipEl = document.getElementById('maxClip');
  const messageEl = document.getElementById('message');

  const switchBtn = document.getElementById('switch');
  const zombieUi = document.getElementById('zombieUi');
  const upgradeUi = document.getElementById('upgradeUi');

  const levelEl = document.getElementById('level');
  const costEl = document.getElementById('cost');
  const succEl = document.getElementById('succ');
  const destEl = document.getElementById('dest');
  const sellEl = document.getElementById('sell');
  const upgradeMsgEl = document.getElementById('upgradeMsg');
  const upgradeBtn = document.getElementById('upgradeBtn');
  const sellBtn = document.getElementById('sellBtn');
  const difficultySel = document.getElementById('difficulty');

  let mode = 'zombie'; // or 'upgrade'

  // 게임 변수 (파이게임 버전에서 포팅)
  let player = { x: W/2, y: H/2, r:20, speed:4, maxHp:75, hp:75 };
  let bullets = [];
  let zombies = [];
  let lastShot = 0;
  let shootCooldown = 200;
  let bulletSpeed = 12;
  let bulletRadius = 5;
  let bulletDamage = 250;

  let maxBullets = 30;
  let bulletsInClip = maxBullets;
  let lastReload = 0;
  let reloadTime = 1500;

  let wave = 0;
  let waveInProgress = false;
  let waveCooldown = 3000;
  let waveCooldownStart = 0;

  let gold = 5000;
  let gameOver = false;
  let gameWon = false;

  // 강화 시스템 포팅
  let level = 0;
  const MAX_LEVEL = 20;

  // 강화 확률 (기본은 파이게임값을 가져옴)
  const upgradeRates = {};
  for(let i=0;i<=MAX_LEVEL;i++){
    upgradeRates[i] = {succ: Math.max(100 - i*5, 5), dest: Math.max((i-5)*5,0)};
  }

  // 강화 비용 (5강 후 6배 증가)
  const upgradeCost = {};
  let base = 100;
  for(let i=0;i<=MAX_LEVEL;i++){
    if(i<=4) upgradeCost[i] = base + i*50;
    else upgradeCost[i] = upgradeCost[i-1] * 6;
  }

  function getSellMultiplier(lv){
    if(lv==0) return 0;
    if(lv>=18) return 70;
    if(lv>=16) return 45;
    if(lv>=13) return 30;
    if(lv>=10) return 20;
    if(lv>=7) return 10;
    if(lv>=5) return 5;
    return 1;
  }

  const sellPrice = {};
  let tot=0;
  for(let i=0;i<=MAX_LEVEL;i++){
    tot += upgradeCost[i];
    sellPrice[i] = Math.floor(tot * 1.1 * getSellMultiplier(i));
  }

  // 입력
  const keys = {};
  window.addEventListener('keydown', e=>{keys[e.key.toLowerCase()]=true; if(e.key.toLowerCase()==='r'){ if(gameOver||gameWon) reset(); else reload(); }});
  window.addEventListener('keyup', e=>{keys[e.key.toLowerCase()]=false});
  let mouse = {x:0,y:0,down:false};
  canvas.addEventListener('mousemove', e=>{const r=canvas.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top});
  canvas.addEventListener('mousedown', e=>{mouse.down=true});
  canvas.addEventListener('mouseup', e=>{mouse.down=false});

  // 터치 (간단)
  canvas.addEventListener('touchstart', e=>{mouse.down=true; const r=canvas.getBoundingClientRect(); mouse.x=e.touches[0].clientX-r.left; mouse.y=e.touches[0].clientY-r.top; e.preventDefault();});
  canvas.addEventListener('touchmove', e=>{const r=canvas.getBoundingClientRect(); mouse.x=e.touches[0].clientX-r.left; mouse.y=e.touches[0].clientY-r.top; e.preventDefault();});
  canvas.addEventListener('touchend', e=>{mouse.down=false; e.preventDefault();});

  // 메시지
  let messageTimer = 0;
  function showMessage(text, dur=2000){ messageEl.textContent = text; messageTimer = Date.now() + dur; }
  function showUpgradeMessage(text, dur=2000){ upgradeMsgEl.textContent = text; setTimeout(()=>{ if(upgradeMsgEl.textContent===text) upgradeMsgEl.textContent=''; }, dur); }

  // 적 클래스처럼 간단한 팩토리
  function spawnZombie(x,y){
    const types = [ {hp:50,speed:randomRange(1.5,3),dmg:10,rad:18}, {hp:80,speed:randomRange(1.5,2.5),dmg:20,rad:20}, {hp:120,speed:randomRange(1.5,2),dmg:30,rad:22} ];
    const t = types[Math.floor(Math.random()*types.length)];
    zombies.push({x,y,hp:t.hp,maxHp:t.hp,speed:t.speed,dmg:t.dmg,rad:t.rad,lastAttack:0,attackCooldown: [800,1200,1500][Math.floor(Math.random()*3)]});
  }
  function spawnBoss(x,y){ zombies.push({x,y,hp:2000,maxHp:2000,speed:1.7,dmg:50,rad:45,lastAttack:0,attackCooldown:900,isBoss:true}); }

  function spawnHorde(num=7,isBoss=false){
    if(isBoss){
      const side = ['top','bottom','left','right'][Math.floor(Math.random()*4)];
      let x=0,y=0;
      if(side==='top'){x=randomInt(0,W);y=-60}
      if(side==='bottom'){x=randomInt(0,W);y=H+60}
      if(side==='left'){x=-60;y=randomInt(0,H)}
      if(side==='right'){x=W+60;y=randomInt(0,H)}
      spawnBoss(x,y);
      return;
    }
    for(let i=0;i<num;i++){
      const side = ['top','bottom','left','right'][Math.floor(Math.random()*4)];
      let x=0,y=0;
      if(side==='top'){x=randomInt(0,W);y=-36}
      if(side==='bottom'){x=randomInt(0,W);y=H+36}
      if(side==='left'){x=-36;y=randomInt(0,H)}
      if(side==='right'){x=W+36;y=randomInt(0,H)}
      spawnZombie(x,y);
    }
  }

  function randomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  function randomRange(a,b){return a + Math.random()*(b-a)}

  function reset(){
    player.x = W/2; player.y = H/2; player.hp = player.maxHp;
    bullets=[]; zombies=[]; bulletsInClip = maxBullets; lastReload = 0; wave=0; waveInProgress=false; gameOver=false; gameWon=false; showMessage(''); spawnNextWave();
  }

  function spawnNextWave(){
    wave++; waveInProgress=true; const diff = parseFloat(difficultySel.value);
    const count = Math.min(7 + (wave-1)*2, 27);
    if(wave===20){ spawnHorde(1,true); gold+=10000; showMessage('보스 등장! 골드 10000 획득!',3000); }
    else{ spawnHorde(Math.floor(count*diff)); showMessage(`웨이브 ${wave} 시작!`,2000); }
    waveEl.textContent = '웨이브: ' + wave;
  }

  function reload(){ const now = Date.now(); if(now - lastReload > reloadTime){ bulletsInClip = maxBullets; lastReload = now; showMessage('재장전 완료!'); }}

  // 초기화
  reset();

  // 업그레이드 UI 초기화
  function updateUpgradeUI(){ levelEl.textContent = level; costEl.textContent = upgradeCost[level] || '-'; succEl.textContent = upgradeRates[level].succ; destEl.textContent = upgradeRates[level].dest; sellEl.textContent = sellPrice[level]; }
  updateUpgradeUI();

  // 강화 버튼 동작
  upgradeBtn.addEventListener('click', ()=>{
    const cost = upgradeCost[level];
    if(gold < cost){ showUpgradeMessage('골드 부족!'); return; }
    if(level >= MAX_LEVEL){ showUpgradeMessage('최대 레벨입니다.'); return; }
    gold -= cost; updateGold();
    const r = Math.floor(Math.random()*100)+1;
    const rates = upgradeRates[level];
    if(r <= rates.succ){ level++; updateUpgradeUI(); showUpgradeMessage(`강화 성공! 현재 레벨: +${level}`); }
    else{ const r2 = Math.floor(Math.random()*100)+1; if(r2 <= rates.dest){ level = 0; updateUpgradeUI(); showUpgradeMessage('강화 실패 및 아이템 파괴!'); } else{ showUpgradeMessage(`강화 실패! 레벨 유지: +${level}`); } }
  });

  sellBtn.addEventListener('click', ()=>{
    if(level===0){ showUpgradeMessage('판매할 아이템이 없습니다.'); return; }
    const val = sellPrice[level]; gold += val; level = 0; updateUpgradeUI(); updateGold(); showUpgradeMessage(`아이템 판매 완료! 골드 +${val}`);
  });

  function updateGold(){ goldEl.textContent = '골드: ' + gold; }
  updateGold();

  // 모드 전환
  switchBtn.addEventListener('click', ()=>{
    if(mode==='zombie'){ mode='upgrade'; zombieUi.style.display='none'; upgradeUi.style.display='block'; switchBtn.textContent='좀비 게임으로 이동'; }
    else{ mode='zombie'; zombieUi.style.display='block'; upgradeUi.style.display='none'; switchBtn.textContent='강화 게임으로 이동'; reset(); }
  });

  // 게임 루프
  let last = performance.now();
  function loop(now){
    const dt = now - last; last = now;
    // 업데이트
    if(mode==='zombie'){
      // 입력
      let mvx=0,mvy=0; if(keys['w']) mvy=-1; if(keys['s']) mvy=1; if(keys['a']) mvx=-1; if(keys['d']) mvx=1; if(mvx!==0||mvy!==0){ const len = Math.hypot(mvx,mvy); mvx/=len; mvy/=len; player.x += mvx*player.speed; player.y += mvy*player.speed; player.x = Math.max(player.r, Math.min(W-player.r, player.x)); player.y = Math.max(player.r, Math.min(H-player.r, player.y)); }

      // 조준 각도
      const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);

      // 발사
      if(mouse.down && bulletsInClip>0 && Date.now()-lastShot>shootCooldown && !gameOver && !gameWon){ bullets.push({x:player.x,y:player.y,angle}); bulletsInClip--; lastShot=Date.now(); }

      // 총알 업데이트
      for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; b.x += Math.cos(b.angle)*bulletSpeed; b.y += Math.sin(b.angle)*bulletSpeed; if(b.x<0||b.x>W||b.y<0||b.y>H){ bullets.splice(i,1); continue; } // 충돌 체크
        for(let j=0;j<zombies.length;j++){ const z = zombies[j]; const dx=b.x-z.x, dy=b.y-z.y; if(Math.hypot(dx,dy) < z.rad + bulletRadius){ z.hp -= bulletDamage; bullets.splice(i,1); if(z.hp<=0){ gold += (z.isBoss? 10000:1000); if(z.isBoss){ gameWon=true; showMessage('보스 처치! 승리! R키로 재시작',4000);} zombies.splice(j,1); } break; } }
      }

      // 좀비 이동/공격
      if(!gameOver && !gameWon){ for(let z of zombies){ const dx=player.x - z.x, dy=player.y - z.y; const dist = Math.hypot(dx,dy); if(dist>0){ const nx = dx/dist, ny = dy/dist; let moveSpeed = z.speed; if(dist>250) moveSpeed *= 1.8; else if(dist>150) moveSpeed *= 1.3; z.x += nx*moveSpeed; z.y += ny*moveSpeed; }
          const attackRange = player.r + z.rad + 5; if(dist <= attackRange && Date.now() - z.lastAttack > z.attackCooldown){ player.hp -= z.dmg; z.lastAttack = Date.now(); showMessage(`피해 -${z.dmg}`,1500); if(player.hp<=0){ player.hp=0; gameOver=true; showMessage('사망했습니다. R키로 재시작하세요.',4000); } }
        }
      }

      // 웨이브 클리어
      if(waveInProgress && zombies.length===0 && !gameOver && !gameWon){ waveInProgress=false; waveCooldownStart = Date.now(); const reward = wave * 200; gold += reward; updateGold(); showMessage(`웨이브 ${wave} 완료! 보상 +${reward} 골드. 다음 웨이브 준비중...`,2500); }
      if(!waveInProgress && !gameOver && !gameWon){ if(Date.now() - waveCooldownStart > waveCooldown) spawnNextWave(); }

      // UI 업데이트
      hpEl.textContent = player.hp; maxHpEl.textContent = player.maxHp; clipEl.textContent = bulletsInClip; maxClipEl.textContent = maxBullets; updateGold();
    }

    // 그리기
    ctx.clearRect(0,0,W,H);
    if(mode==='zombie'){
      // 플레이어
      drawPlayer();
      // 좀비
      for(let z of zombies) drawZombie(z);
      // 총알
      for(let b of bullets) drawBullet(b);

      // 메시지 타이머
      if(messageTimer < Date.now()) messageEl.textContent = '';
    } else {
      // 업그레이드 모드에서 간단한 배경
      ctx.fillStyle = '#1e1e1e'; ctx.fillRect(0,0,W,H);
    }

    requestAnimationFrame(loop);
  }

  function drawPlayer(){ // 몸통
    ctx.fillStyle = '#00c050'; ctx.beginPath(); ctx.arc(player.x, player.y, player.r,0,Math.PI*2); ctx.fill(); // 눈
    const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
    const eyeX = player.x + Math.cos(angle) * (player.r/2);
    const eyeY = player.y + Math.sin(angle) * (player.r/2);
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(eyeX, eyeY, 5,0,Math.PI*2); ctx.fill(); // 총구
    const barrelLen = player.r + 15; const bx = player.x + Math.cos(angle)*barrelLen; const by = player.y + Math.sin(angle)*barrelLen; ctx.strokeStyle='#000'; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(player.x,player.y); ctx.lineTo(bx,by); ctx.stroke();
  }
  function drawBullet(b){ ctx.fillStyle='#ffff66'; ctx.beginPath(); ctx.arc(b.x,b.y,bulletRadius,0,Math.PI*2); ctx.fill(); }
  function drawZombie(z){ // 몸
    ctx.fillStyle = z.isBoss ? '#ffd54f' : '#2e7d32'; ctx.beginPath(); ctx.arc(z.x,z.y,z.rad,0,Math.PI*2); ctx.fill(); ctx.fillStyle = z.isBoss? '#fff8e1':'#a5d6a7'; ctx.beginPath(); ctx.arc(z.x, z.y - z.rad/3, z.rad*0.66,0,Math.PI*2); ctx.fill(); // 눈
    ctx.fillStyle = '#dc2b2b'; ctx.beginPath(); ctx.arc(z.x - (z.rad>20?15:7), z.y - z.rad/3 - (z.rad>20?8:5),  z.rad>20?7:4,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(z.x + (z.rad>20?15:7), z.y - z.rad/3 - (z.rad>20?8:5),  z.rad>20?7:4,0,Math.PI*2); ctx.fill(); // 입
    ctx.strokeStyle = '#8b0000'; ctx.lineWidth = z.isBoss?5:3; ctx.beginPath(); ctx.moveTo(z.x - (z.rad>20?20:7), z.y - z.rad/3 + (z.rad>20?15:8)); ctx.lineTo(z.x + (z.rad>20?20:7), z.y - z.rad/3 + (z.rad>20?15:8)); ctx.stroke(); // hp bar
    ctx.fillStyle = '#8b0000'; ctx.fillRect(z.x - z.rad, z.y - z.rad - 18, z.rad*2, z.isBoss?7:5);
    ctx.fillStyle = '#00c050'; ctx.fillRect(z.x - z.rad, z.y - z.rad - 18, z.rad*2 * Math.max(0,z.hp/z.maxHp), z.isBoss?7:5);
  }

  function gameTick(){ /* unused - kept for parity */ }

  // 도움 함수
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // 유틸
  function setMode(m){ mode = m; if(m==='upgrade'){ zombieUi.style.display='none'; upgradeUi.style.display='block'; switchBtn.textContent='좀비 게임으로 이동'; } else{ zombieUi.style.display='block'; upgradeUi.style.display='none'; switchBtn.textContent='강화 게임으로 이동'; reset(); } }

  // 시작
  requestAnimationFrame(loop);

  // 업그레이드 모드에서 강화 확률/비용 UI 업데이트
  function refreshUpgradeInfo(){ levelEl.textContent = level; costEl.textContent = upgradeCost[level]; succEl.textContent = upgradeRates[level].succ; destEl.textContent = upgradeRates[level].dest; sellEl.textContent = sellPrice[level]; }
  refreshUpgradeInfo();

  // 외부에서 실패율을 올리기 쉽게 함수 제공
  window.setGlobalFailMultiplier = function(mult){ // mult은 1보다 크면 실패율 증가(성공 확률 감소)
    for(let i=0;i<=MAX_LEVEL;i++){
      const s = Math.max( Math.round(upgradeRates[i].succ / mult), 1 );
      upgradeRates[i].succ = s;
    }
    refreshUpgradeInfo();
  }

  // 게임 시작 기준 UI 업데이트
  updateGold();
  </script>
</body>
</html>
