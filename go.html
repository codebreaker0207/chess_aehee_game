<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>강화 게임 (HTML5)</title>
  <style>
    :root{--bg:#0b0b0b;--panel:#1e1e1e;--white:#fff;--green:#00c050;--darkgreen:#2e7d32;--red:#dc2b2b;--gold:#ffd54f;--warning:#ff8c42}
    html,body{height:100%;margin:0;font-family: 'Malgun Gothic', Arial, sans-serif;background:var(--bg);color:var(--white)}
    .wrap{display:flex;align-items:flex-start;justify-content:center;padding:12px}
    canvas{background:#000;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
    .ui{width:320px;margin-left:16px}
    .panel{background:var(--panel);padding:12px;border-radius:8px;margin-bottom:12px}
    h2{margin:0 0 8px 0;font-size:18px}
    .big{font-size:22px;color:var(--gold);font-weight:700}
    button{background:#0e6efc;border:none;color:var(--white);padding:10px 12px;border-radius:8px;cursor:pointer}
    .btn-disabled{opacity:.45;pointer-events:none}
    .row{display:flex;gap:8px;align-items:center}
    .center{text-align:center}
    .msg{color:var(--warning);min-height:24px}
    .stat{font-size:14px}
    .buttons{display:flex;gap:8px;margin-top:8px}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="900" height="600"></canvas>
    <div class="ui">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="big" id="gold">골드: 0</div>
          </div>
        </div>
      </div>

      <div id="upgradeUi" class="panel">
        <h2>아이템 강화</h2>
        <div class="stat">현재 레벨: +<span id="level">0</span></div>
        <div class="stat">강화 비용: <span id="cost">0</span> 골드</div>
        <div class="stat">성공 확률: <span id="succ">0</span>%</div>
        <div class="stat">파괴 확률: <span id="dest">0</span>%</div>
        <div class="stat">판매가: <span id="sell">0</span> 골드</div>
        <div class="buttons">
          <button id="upgradeBtn">강화 시도</button>
          <button id="sellBtn">아이템 판매</button>
        </div>
        <div style="height:8px"></div>
        <div class="msg" id="upgradeMsg"></div>
      </div>

      <div class="panel">
        <h2>메뉴</h2>
        <a href="../index.html#play" id="btthhome" class="chess_b">
          <button class="tbtn"> 돌아가기 </button>
        </a>
      </div>
    </div>
  </div>

  
  <script>
  // --- 기본 설정 ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // UI 엘리먼트
  const goldEl = document.getElementById('gold');
  const levelEl = document.getElementById('level');
  const costEl = document.getElementById('cost');
  const succEl = document.getElementById('succ');
  const destEl = document.getElementById('dest');
  const sellEl = document.getElementById('sell');
  const upgradeMsgEl = document.getElementById('upgradeMsg');
  const upgradeBtn = document.getElementById('upgradeBtn');
  const sellBtn = document.getElementById('sellBtn');

  let gold = 5000;

  // 강화 시스템 포팅
  let level = 0;
  const MAX_LEVEL = 20;

  // 강화 확률 (기본은 파이게임값을 가져옴)
  const upgradeRates = {};
  for(let i=0;i<=MAX_LEVEL;i++){
    upgradeRates[i] = {succ: Math.max(100 - i*5, 5), dest: Math.max((i-5)*5,0)};
  }

  // 강화 비용 (5강 후 6배 증가)
  const upgradeCost = {};
  let base = 100;
  for(let i=0;i<=MAX_LEVEL;i++){
    if(i<=4) upgradeCost[i] = base + i*50;
    else upgradeCost[i] = upgradeCost[i-1] * 6;
  }

  function getSellMultiplier(lv){
    if(lv==0) return 0;
    if(lv>=18) return 70;
    if(lv>=16) return 45;
    if(lv>=13) return 30;
    if(lv>=10) return 20;
    if(lv>=7) return 10;
    if(lv>=5) return 5;
    return 1;
  }

  const sellPrice = {};
  let tot=0;
  for(let i=0;i<=MAX_LEVEL;i++){
    tot += upgradeCost[i];
    sellPrice[i] = Math.floor(tot * 1.1 * getSellMultiplier(i));
  }

  function showUpgradeMessage(text, dur=2000){
    upgradeMsgEl.textContent = text;
    setTimeout(()=>{ if(upgradeMsgEl.textContent===text) upgradeMsgEl.textContent=''; }, dur);
  }

  // 업그레이드 UI 초기화
  function updateUpgradeUI(){
    levelEl.textContent = level;
    costEl.textContent = upgradeCost[level] || '-';
    succEl.textContent = upgradeRates[level].succ;
    destEl.textContent = upgradeRates[level].dest;
    sellEl.textContent = sellPrice[level];
  }
  updateUpgradeUI();

  // 강화 버튼 동작
  upgradeBtn.addEventListener('click', ()=>{
    const cost = upgradeCost[level];
    if(gold < cost){ showUpgradeMessage('골드 부족!'); return; }
    if(level >= MAX_LEVEL){ showUpgradeMessage('최대 레벨입니다.'); return; }
    gold -= cost; updateGold();
    const r = Math.floor(Math.random()*100)+1;
    const rates = upgradeRates[level];
    if(r <= rates.succ){ level++; updateUpgradeUI(); showUpgradeMessage(`강화 성공! 현재 레벨: +${level}`); }
    else{ const r2 = Math.floor(Math.random()*100)+1; if(r2 <= rates.dest){ level = 0; updateUpgradeUI(); showUpgradeMessage('강화 실패 및 아이템 파괴!'); } else{ showUpgradeMessage(`강화 실패! 레벨 유지: +${level}`); } }
  });

  sellBtn.addEventListener('click', ()=>{
    if(level===0){ showUpgradeMessage('판매할 아이템이 없습니다.'); return; }
    const val = sellPrice[level];
    gold += val; level = 0; updateUpgradeUI(); updateGold();
    showUpgradeMessage(`아이템 판매 완료! 골드 +${val}`);
  });

  function updateGold(){ goldEl.textContent = '골드: ' + gold; }
  updateGold();

  // 게임 루프
  let last = performance.now();
  function loop(now){
    last = now;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = '#1e1e1e';
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#2e2e2e';
    ctx.fillRect(40,40,W-80,H-80);
    ctx.fillStyle = '#ffd54f';
    ctx.font = '28px Malgun Gothic, Arial, sans-serif';
    ctx.fillText('강화 게임', 60, 90);
    drawUpgradeVisual();

    requestAnimationFrame(loop);
  }

  function drawUpgradeVisual(){
    const centerX = W / 2;
    const centerY = H / 2 + 40;
    const baseSize = 60;
    const size = baseSize + Math.min(level, MAX_LEVEL) * 4;
    const colors = ['#cfd8dc', '#b0bec5', '#90a4ae', '#80cbc4', '#4db6ac', '#26a69a', '#26c6da', '#29b6f6', '#42a5f5', '#5c6bc0', '#7e57c2', '#ab47bc', '#ec407a', '#ef5350', '#ffa726', '#ffb300', '#fdd835', '#d4e157', '#9ccc65', '#66bb6a', '#26a69a'];
    const color = colors[Math.min(level, colors.length - 1)];
    const glow = 10 + level * 1.5;

    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.shadowColor = color;
    ctx.shadowBlur = glow;

    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(0, 0, size, 0, Math.PI * 2);
    ctx.fill();

    ctx.shadowBlur = 0;
    ctx.fillStyle = '#111';
    ctx.beginPath();
    ctx.arc(0, 0, size - 16, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = color;
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(-size * 0.55, 0);
    ctx.lineTo(size * 0.55, 0);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, -size * 0.55);
    ctx.lineTo(0, size * 0.55);
    ctx.stroke();

    ctx.fillStyle = '#ffd54f';
    ctx.font = '22px Malgun Gothic, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`+${level}`, 0, 0);
    ctx.restore();
  }

  // 시작
  requestAnimationFrame(loop);

  // 외부에서 실패율을 올리기 쉽게 함수 제공
  window.setGlobalFailMultiplier = function(mult){ // mult은 1보다 크면 실패율 증가(성공 확률 감소)
    for(let i=0;i<=MAX_LEVEL;i++){
      const s = Math.max( Math.round(upgradeRates[i].succ / mult), 1 );
      upgradeRates[i].succ = s;
    }
    updateUpgradeUI();
  }
  </script>

</body>
</html>
