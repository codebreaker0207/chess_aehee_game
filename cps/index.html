<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CPS 측정기 + 실시간 그래프</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 2em;
      font-family: sans-serif;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 0.5em; }
    select, button {
      font-size: 1rem;
      padding: 0.5em 1em;
      margin: 0.5em;
    }
    #click-area {
      margin-top: 1em;
      width: 300px;
      height: 300px;
      background: #fff;
      border: 4px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      user-select: none;
    }
    #click-area.disabled {
      background: #ddd;
      cursor: not-allowed;
    }
    #graph {
      margin-top: 1.5em;
      border: 1px solid #333;
      background: #fff;
    }
    #results {
      margin-top: 1em;
      font-size: 1.2rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>CPS 테스트 + 실시간 그래프</h1>

  <div>
    <label for="duration">측정 시간: </label>
    <select id="duration">
      <option value="1">1초</option>
      <option value="3">3초</option>
      <option value="5">5초</option>
      <option value="10" selected>10초</option>
      <option value="15">15초</option>
      <option value="30">30초</option>
      <option value="60">60초</option>
    </select>
    <button id="start-btn">시작</button>
  </div>

  <div id="click-area" class="disabled">클릭 준비</div>

  <canvas id="graph" width="600" height="200"></canvas>

  <div id="results"></div>

  <script>
    const startBtn = document.getElementById('start-btn');
    const clickArea = document.getElementById('click-area');
    const durationSelect = document.getElementById('duration');
    const results = document.getElementById('results');
    const canvas = document.getElementById('graph');
    const ctx = canvas.getContext('2d');

    let totalClicks = 0;
    let prevTotal = 0;
    let timeLeft = 0;
    let duration = 0;
    let timerId = null;
    let secondIndex = 0;
    const maxCps = 20;  // 그래프 y축 최대값

    function resetCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // 축 그리기
      ctx.strokeStyle = '#333';
      ctx.beginPath();
      ctx.moveTo(40, 10);
      ctx.lineTo(40, canvas.height - 30);
      ctx.lineTo(canvas.width - 10, canvas.height - 30);
      ctx.stroke();
      // y축 레이블
      ctx.fillStyle = '#333';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= maxCps; i += 5) {
        const y = mapY(i);
        ctx.fillText(i, 35, y);
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(canvas.width - 10, y);
        ctx.strokeStyle = '#eee';
        ctx.stroke();
        ctx.strokeStyle = '#333';
      }
    }

    function mapX(sec) {
      const plotWidth = canvas.width - 50;
      return 40 + (plotWidth * sec / (duration - 1 || 1));
    }

    function mapY(value) {
      const plotHeight = canvas.height - 40;
      const pct = Math.min(value / maxCps, 1);
      return canvas.height - 30 - (plotHeight * pct);
    }

    function updateClickArea(text, disabled) {
      clickArea.textContent = text;
      clickArea.classList.toggle('disabled', disabled);
    }

    function startTest() {
      totalClicks = 0;
      prevTotal = 0;
      duration = parseInt(durationSelect.value, 10);
      timeLeft = duration;
      secondIndex = 0;
      results.textContent = '';
      startBtn.disabled = true;
      durationSelect.disabled = true;

      resetCanvas();

      // 클릭 시작과 동시에 즉시 활성화
      updateClickArea(timeLeft + '초 남음', false);

      timerId = setInterval(() => {
        timeLeft--;
        // 1초 구간 클릭 수 계산 & 점 찍기
        const clicksThisSec = totalClicks - prevTotal;
        prevTotal = totalClicks;
        const x = mapX(secondIndex);
        const y = mapY(clicksThisSec);
        ctx.fillStyle = '#d33';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
        secondIndex++;

        if (timeLeft > 0) {
          updateClickArea(timeLeft + '초 남음', false);
        } else {
          endTest();
        }
      }, 1000);
    }

    function endTest() {
      clearInterval(timerId);
      updateClickArea('테스트 종료', true);
      const cps = (totalClicks / duration).toFixed(2);
      results.innerHTML = `
        총 클릭 수: <strong>${totalClicks}</strong><br/>
        평균 CPS: <strong>${cps}</strong>
      `;
      startBtn.disabled = false;
      durationSelect.disabled = false;
      startBtn.textContent = '다시 시작';
    }

    clickArea.addEventListener('click', () => {
      if (!clickArea.classList.contains('disabled')) {
        totalClicks++;
      }
    });

    startBtn.addEventListener('click', startTest);
  </script>
</body>
</html>
